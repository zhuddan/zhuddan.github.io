"use strict";(self.webpackChunkzhuddan_github_io=self.webpackChunkzhuddan_github_io||[]).push([[4680],{7894:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>l,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"mini/auth","title":"\u5fae\u4fe1\u767b\u5f55\u6388\u6743\u5904\u7406","description":"\u53c2\u8003\u516c\u4f17\u53f7\u7f51\u9875\u6388\u6743","source":"@site/archived/mini/auth.md","sourceDirName":"mini","slug":"/mini/auth","permalink":"/docs/mini/auth","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"To be Improved","permalink":"/docs/tags/to-be-improved"}],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7,"tags":["To be Improved"]},"sidebar":"archived","previous":{"title":"\u767b\u5f55\u903b\u8f91\u5904\u7406","permalink":"/docs/mini/login"},"next":{"title":"\u6742\u9879","permalink":"/docs/category/\u6742\u9879"}}');var o=t(6070),i=t(2790);const a={sidebar_position:7,tags:["To be Improved"]},s="\u5fae\u4fe1\u767b\u5f55\u6388\u6743\u5904\u7406",c={},d=[];function u(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",header:"header",mermaid:"mermaid",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"\u5fae\u4fe1\u767b\u5f55\u6388\u6743\u5904\u7406",children:"\u5fae\u4fe1\u767b\u5f55\u6388\u6743\u5904\u7406"})}),"\n",(0,o.jsxs)(n.p,{children:["\u53c2\u8003",(0,o.jsx)(n.a,{href:"https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html",children:"\u516c\u4f17\u53f7\u7f51\u9875\u6388\u6743"})]}),"\n",(0,o.jsx)(n.mermaid,{value:"graph TD;\n    A[\u5f00\u59cb] --\x3e B[\u8fdb\u5165\u7f51\u9875]\n    B --\x3e C{location.href\u5426\u5305\u542bcode?}\n    C --\x3e|\u662f| D[\u63d0\u4ea4code\u7ed9\u5f00\u53d1\u8005\u540e\u53f0]\n    C --\x3e|\u5426| E[\u8df3\u8f6c\u5fae\u4fe1\u6388\u6743]\n    D --\x3e F[\u83b7\u53d6\u767b\u5f55\u51ed\u8bc1]\n    F --\x3e G[\u7ed3\u675f]\n    E --\x3e B[\u8fdb\u5165\u7f51\u9875]"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"react \u9879\u76ee\u4e3a\u4f8b"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-tsx",metastring:'title="main.tsx"',children:"import React from 'react'\nimport ReactDOM from 'react-dom/client'\nimport App from './App.tsx'\nimport { getTokenCookie } from './utils/cookie.ts'\nimport { wxAuth } from './utils/wx'\n\n/**\n * init app\n */\nfunction renderApp() {\n  ReactDOM.createRoot(document.getElementById('root')!).render(\n    /**\n     * do not remove StrictMode it will cause error\n     * @see https://react.dev/reference/react/StrictMode\n     */\n    <React.StrictMode>\n      <App />\n    </React.StrictMode>,\n  )\n}\n\n/**\n * init wx auth\n */\nfunction handleWxAuthorization() {\n  const url = new URL(window.location.href)\n  const code = url.searchParams.get('code')\n  if (code) {\n    try {\n      renderApp()\n    }\n    catch (error) {\n      console.error('\u5fae\u4fe1\u767b\u5f55\u5931\u8d25:', error)\n      wxAuth() // \u5931\u8d25\u65f6\u91cd\u65b0\u5f15\u5bfc\u6388\u6743\n    }\n  }\n  else {\n    wxAuth()\n  }\n}\n\n/**\n * init\n */\nasync function init() {\n  if (getTokenCookie()) {\n    renderApp()\n  }\n  else {\n    handleWxAuthorization()\n  }\n}\n\ninit()\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="./utils/wx.ts"',children:"/**\n * @description \u5fae\u4fe1\u6388\u6743\n */\nexport function wxAuth() {\n  // \u5f53\u524d\u5730\u5740\n  const currentUrl = new URL(window.location.href)\n  // \u53c2\u6570\n  const state = currentUrl.searchParams.get('state') ?? 'state'\n\n  const appid = import.meta.env.VITE_APP_WX_APP_ID\n\n  const redirect_uri = currentUrl.href\n\n  const wxAuthUrl = new URL('https://open.weixin.qq.com/connect/oauth2/authorize')\n  wxAuthUrl.searchParams.set('appid', appid)\n  wxAuthUrl.searchParams.set('redirect_uri', redirect_uri)\n  wxAuthUrl.searchParams.set('response_type', 'code')\n  wxAuthUrl.searchParams.set('scope', 'snsapi_userinfo')\n  wxAuthUrl.searchParams.set('state', state)\n  wxAuthUrl.hash = 'wechat_redirect'\n  window.location.href = wxAuthUrl.href\n}\n"})})]})}function l(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(u,{...e})}):u(e)}},2790:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>s});var r=t(758);const o={},i=r.createContext(o);function a(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);