"use strict";(self.webpackChunkzhuddan_github_io=self.webpackChunkzhuddan_github_io||[]).push([[8669],{8933:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"mini/socket","title":"socket","description":"\u4ee5 uni-app \u4e3a\u4f8b","source":"@site/archived/mini/socket.md","sourceDirName":"mini","slug":"/mini/socket","permalink":"/docs/mini/socket","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"To be Improved","permalink":"/docs/tags/to-be-improved"}],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"tags":["To be Improved"]},"sidebar":"archived","previous":{"title":"\u84dd\u7259\u6a21\u5757","permalink":"/docs/mini/bluetooth"},"next":{"title":"mqtt","permalink":"/docs/mini/mqtt"}}');var o=t(6070),i=t(6599);const r={sidebar_position:3,tags:["To be Improved"]},c="socket",a={},l=[];function h(e){const n={code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"socket",children:"socket"})}),"\n",(0,o.jsxs)(n.p,{children:["\u4ee5 ",(0,o.jsx)(n.code,{children:"uni-app"})," \u4e3a\u4f8b"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"import type { IMessageData } from './types'\n\nimport { debounce, EventEmitter, getCacheUserInfo, parseJSON } from '@cloud/shared'\n\nexport * from './types'\n\nexport class CloudWebSocket extends EventEmitter<{\n  connect: () => void\n  message: (messageData: IMessageData) => void\n  open: (open: UniApp.OnSocketOpenCallbackResult) => void\n  close: (reason: string) => void\n  error: (error?: string) => void\n  log: (msg: string) => void\n}> {\n  url: string\n  isCreate: boolean\n  isConnect: boolean\n  isInitiative: boolean\n  socketInstance: null | UniNamespace.SocketTask = null\n  reconnectTimer: NodeJS.Timeout | null = null\n  retryTime = 5\n  // 'ws://192.168.0.72:9204/websocket'\n  constructor(url = SOCKET_URL) {\n    super()\n    this.url = url\n    this.isCreate = false // WebSocket \u662f\u5426\u521b\u5efa\u6210\u529f\n    this.isConnect = false // \u662f\u5426\u5df2\u7ecf\u8fde\u63a5\n    this.isInitiative = false // \u662f\u5426\u4e3b\u52a8\u65ad\u5f00\n    this.socketInstance = null // websocket\u5b9e\u4f8b\n  }\n\n  // \u521d\u59cb\u5316websocket\u8fde\u63a5\n  initSocket = debounce(() => {\n    this.isCreate = false\n    this.isConnect = false\n    this.isInitiative = false\n    this.socketInstance = null\n    this.emit('log', '\ud83d\udedc \u521d\u59cb\u5316websocket\u8fde\u63a5')\n    this.socketInstance = uni.connectSocket({\n      url: this.url,\n      header: {\n        'content-type': 'application/json',\n      },\n      success: () => {\n        this.isCreate = true\n        console.log('[ws]', '\u5df2\u7ecf\u8fde\u63a5')\n        this.emit('connect')\n      },\n      fail: (err) => {\n        console.error(err)\n        this.isCreate = false\n      },\n    })\n    this.createSocket()\n  })\n\n  // \u521b\u5efawebsocket\u8fde\u63a5\n  createSocket() {\n    if (this.isCreate) {\n      this.emit('log', '\ud83d\udedc WebSocket \u5f00\u59cb\u521d\u59cb\u5316')\n      // \u76d1\u542c WebSocket \u8fde\u63a5\u6253\u5f00\u4e8b\u4ef6\n      try {\n        this.socketInstance?.onOpen((res) => {\n          this.emit('log', '\ud83d\udedc WebSocket \u8fde\u63a5\u6210\u529f')\n          this.isConnect = true\n          this.emit('open', res)\n\n          // \u6253\u5f00\u5fc3\u8df3\u68c0\u6d4b\n        })\n        // \u76d1\u542c WebSocket \u63a5\u53d7\u5230\u670d\u52a1\u5668\u7684\u6d88\u606f\u4e8b\u4ef6\n        this.socketInstance?.onMessage((res) => {\n          const _data = JSON.parse(res.data)\n          const data = {\n            msgType: _data.msgType,\n            val: parseJSON(_data.val),\n          }\n          this.emit('log', `\u2709\ufe0f ${data.msgType} ${JSON.stringify(data.val) || 'no message'}`)\n          this.emit('message', data)\n        })\n        // \u76d1\u542c WebSocket \u8fde\u63a5\u5173\u95ed\u4e8b\u4ef6\n        this.socketInstance?.onClose((e) => {\n          // if (e.code === 1006 || e.code === 1000 || e.code === 1001) {\n          // if (e.code === 1006) {\n          //   console.log(`${e.code} error`);\n          //   this.onClose(`${e.code} error`);\n          //   return;\n          // }\n          if (e.reason === 'logout') {\n            this.emit('log', '\ud83d\udedc \u670d\u52a1\u5668\u5173\u95ed logout')\n            return\n          }\n          if (e.reason === 'no-user-info') {\n            this.emit('log', '\ud83d\udedc \u5ba2\u6237\u7aef\u5173\u95ed no-user-info')\n            return\n          }\n\n          this.emit('log', `\ud83d\udedc \u5176\u4ed6\u539f\u56e0\u5173\u95ed ${e.code} ${e.reason}`)\n          console.log('e', e)\n          console.log('WebSocket \u5173\u95ed\u4e86')\n\n          const id = getCacheUserInfo()?.id\n          this.isInitiative = false\n          this.isConnect = false\n          if (id)\n            this.reconnect()\n        })\n        // \u76d1\u542c WebSocket \u9519\u8bef\u4e8b\u4ef6\n        this.socketInstance?.onError((e) => {\n          this.emit('log', `\ud83d\udedc \u51fa\u9519\u4e86 ${e.errMsg}`)\n          console.log('WebSocket \u51fa\u9519\u4e86', e)\n          this.isInitiative = false\n          this.isConnect = false\n          this.reconnect()\n        })\n      }\n      catch (error) {\n        this.emit('log', '\ud83d\udedc \u521b\u5efa\u51fa\u9519\u4e86')\n        console.warn(error)\n      }\n    }\n    else {\n      this.emit('log', '\ud83d\udedc \u521d\u59cb\u5316\u5931\u8d25!')\n    }\n  }\n\n  // \u53d1\u9001\u6d88\u606f\n  sendMessage(value: any) {\n    const param = JSON.stringify(value)\n    this.emit('log', `\ud83d\udedc sendMessage ${param}`)\n    return new Promise((resolve, reject) => {\n      this.socketInstance?.send({\n        data: param,\n        success() {\n          console.log('\u6d88\u606f\u53d1\u9001\u6210\u529f', value)\n          resolve(true)\n        },\n        fail(error) {\n          console.log('\u6d88\u606f\u53d1\u9001\u5931\u8d25')\n          reject(error)\n        },\n      })\n    })\n  }\n\n  // // \u91cd\u65b0\u8fde\u63a5\n  reconnect = debounce(() => {\n    // \u505c\u6b62\u53d1\u9001\u5fc3\u8df3\n    // clearTimeout(this.reconnectTimer!);\n    // \u5982\u679c\u4e0d\u662f\u4eba\u4e3a\u5173\u95ed\u7684\u8bdd\uff0c\u8fdb\u884c\u91cd\u8fde\n\n    this.emit('log', `\ud83d\udedc reconnect ${this.isInitiative}`)\n    if (!this.isInitiative) {\n      this.emit('log', '\ud83d\udedc \u91cd\u65b0\u8fde\u63a5 initSocket')\n      this.initSocket()\n    }\n    else {\n      // this.emit('log', '\ud83d\udedc \u91cd\u65b0\u8fde\u63a5 initSocket');\n    }\n  }, 300)\n\n  // \u5173\u95ed WebSocket \u8fde\u63a5\n  closeSocket(reason = '\u5173\u95ed') {\n    this.emit('log', '\ud83d\udedc \u5173\u95ed')\n\n    if (!this.socketInstance || !this.isCreate)\n      return\n    this.socketInstance?.close({\n      reason,\n      success: () => {\n        this.onClose(reason)\n      },\n      fail: (e) => {\n        console.log(e)\n        this.emit('log', '\ud83d\udedc \u5173\u95ed WebSocket \u5931\u8d25222')\n        this.emit('error', `${JSON.stringify(e)}`)\n        this.onClose('\u5173\u95ed WebSocket \u5931\u8d25 \u5f3a\u884c\u5173\u95ed')\n        this.reconnect()\n        this.emit('log', `\ud83d\udedc isCreate ${this.isCreate} 222`)\n      },\n    })\n  }\n\n  onClose(reason: string) {\n    this.emit('log', `\ud83d\udedc onClose reason >>> ${reason}`)\n    this.isCreate = false\n    this.isConnect = false\n    this.isInitiative = true\n    this.socketInstance = null\n    this.emit('close', reason)\n    this.reset()\n  }\n}\n"})})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},6599:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>c});var s=t(758);const o={},i=s.createContext(o);function r(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);