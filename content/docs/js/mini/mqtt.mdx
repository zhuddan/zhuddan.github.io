---
title: mqtt
---


## å®‰è£…

<NodeCmd type="install" cmd="mqtt@3.0.0" />

## ç±»åž‹å£°æ˜Ž

```ts title="mqtt.min.d.ts"
import * as mqtt from 'mqtt'

export declare module './mqtt.min.js' {
  export = mqtt
}
```

## ä½¿ç”¨

```ts
import { EventEmitter } from '@cloud/shared'
import mqtt from 'mqtt/dist/mqtt.min.js'  // [!code highlight]

export class Mq extends EventEmitter<{
  message: (deviceNo: string, data: any) => void
}> {
  client: mqtt.MqttClient | null = null
  topic: string[] = []
  init(options: mqtt.IClientOptions, topic: string[]) {
    if (!this.client) {
      console.log('mqtt init ðŸš€ðŸš€ðŸš€ðŸš€ client init')
      this.client = mqtt.connect(MQTT_URL, options)
      this.topic = topic
      this.client.on('error', (err) => {
        console.log(err, 'err')
      })

      this.client.on('connect', () => {
        console.log('topic', topic)
        this.client?.subscribe(topic, (e) => {
          console.log(`è®¢é˜…äº†ä¸»é¢˜3 ${topic.join('å’Œ')}`)
          console.log('è®¢é˜…äº†ä¸»é¢˜4 error', [e])
        })
      })
      // eslint-disable-next-line node/prefer-global/buffer
      const handleMsg = (topic: string, message: Buffer) => {
        const data = JSON.parse(message.toString())
        if (Object.keys(data).length !== 0) {
          const deviceNo = topic.replace('/environment/', '')
          const obj = JSON.parse(message.toString())
          const pm25 = obj.pm25
          const co2 = obj.co2
          console.log(`MQ ${pm25 ? 'pro ç‰ˆæœ¬ pm25' : 'é’æ˜¥ç‰ˆæœ¬ co2'}`, pm25 ? pm25.val : co2.val, pm25 ? pm25.info : co2.info)
          this.emit('message', deviceNo, obj)
        }
      }
      this.client?.addListener('message', handleMsg)
    }
    else {
      console.log(' client å·²ç»å­˜åœ¨äº†')
      const _topic = this.topic.filter(e => !topic.includes(e))
      console.log('æœªè®¢é˜…', _topic)
      if (_topic.length) {
        this.client?.subscribe(_topic, (e) => {
          console.log(`è¡¥å…… è®¢é˜…äº†ä¸»é¢˜5 ${_topic.join('å’Œ')}`)
          console.log('è¡¥å…… è®¢é˜…äº†ä¸»é¢˜6 error', [e])
        })
      }
    }
  }

  resetClient() {
    console.log('resetClient >>> ')
    if (this.client) {
      this.client.end()
      this.client = null
      this.topic = []
      this.reset()
    }
  }
}

export const MQ = new Mq()
```
